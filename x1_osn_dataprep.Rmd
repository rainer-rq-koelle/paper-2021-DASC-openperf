---
title: "Trajectory Processing"
author: "PRU"
date: "14/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(arrow)
library(dplyr)
library(purrr)
library(tidyr)
library(sf)
library(sftrack)
library(geosphere)
library(trrrj)
library(h3)
#library(ggplot2)

source("./R/make_nice_names_trafficlib.R")
source('./R/make_unique_id.R')
source('./R/remove_orphans.R')
source('./R/extract_4d_nest.R')
source('./R/confirm_arrival_at.R')
source('./R/cast_sf_utils.R')
source('./R/rwy_system.R')
source('./R/identify_runway.R')
source('./R/estimate_threshold_time.R')
source('./R/calc_crossing.R')
```

## Overview

This Rmd documents the data preparatory steps following the data exploratory stage (c.f. x0_eda ...Rmd).
The focus is on cleaning the eda utility functions to establish the analytic data required for this study.


```{r}
#apt <- "EGLL"
#fns <- list.files(path = "./data-raw/", pattern = paste0(apt,".*\\.feather"), full.names = TRUE)


study_loop <- function(.apt, .fn, .debug = FALSE){
  
# ---------------------- read in airport data --------------------------------  
aip <- readr::read_csv("./data/aip.csv") %>%
  filter(ICAO == .apt)

# ---------------------- load trajectory data --------------------------------
warning(paste(.apt, " - reading - ", .fn))
ds <- read_feather(.fn) %>% as_tibble()

ds <- ds %>% 
  make_nice_names_trafficlib() %>%
  make_unique_id() %>% 
  remove_orphans(500)

meta <- ds %>% group_by(UID) %>% 
  summarise(N = n(), ADEP = unique(ADEP), ADES = unique(ADES)
            ,START = unique(start[!is.na(start)])
            , STOP = unique(stop [!is.na(stop )]) )


# ----------------------- label arrival traffic -------------------------------
phase <- ds %>% 
  extract_4d_nest() %>%
  confirm_arrival_at(aip %>% rwy_system_hull(7000))

meta <- meta %>% left_join(phase %>% select(UID, ARR), by = "UID")

# ---------------------- determine landing runway -----------------------------
rwy_ctr_line_ls <- aip %>% 
  rwy_ctr_line() %>% 
  rwy_ctr_line_pts() %>% 
  cast_latlon_to_pts() %>% cast_pts_to_ls(REF)

arrs <- phase %>% filter(ARR == TRUE) %>%
  
  mutate( rwy = map(.x = last_4d, .f = ~identify_rwy(.x %>% cast_latlon_to_pts() , rwy_ctr_line_ls))
         ,RWY = map(.x = rwy, .f = ~.x %>% filter(TRUST == max(TRUST)) %>% pull(REF))
  ) %>% 
  tidyr::unnest(RWY)

meta <- meta %>% left_join(arrs %>% select(UID, RWY), by = "UID")

# ----------------------- determine threshold time ----------------------------
thrt <- arrs %>% 
  # append runway coordinates
  left_join(aip %>% 
              filter(TYPE == "THR") %>% 
              select(RWY = REF, LAT_THR = LAT, LON_THR = LON)
            , by = "RWY"
            ) %>%
  
  unnest(last_4d) %>% group_by(UID) %>% nest() %>% 
  mutate(THR_TIME = map(.x = data, .f= ~ estimate_threshold_time(.x))
         ) %>% 
  unnest(THR_TIME)

arrs <- arrs %>% left_join(thrt %>% select(UID, THR_TIME), by = "UID")

# ----------------------- determine ASMA crossings ----------------------------
asma <- arrs %>% select(UID, data)  
arp  <- aip %>% filter(TYPE == "ARP") %>% df_to_geo_lonlat()

asma <- asma %>% 
  mutate(
    C40 = map( .x = data
              ,.f = ~ extract_pos_at_distance_from_point(.x, .pt = arp , .dist = 40)
            )
    ,C50= map( .x = data
              ,.f = ~ extract_pos_at_distance_from_point(.x, .pt = arp , .dist = 50)
            )
    ,C100= map( .x = data
              ,.f = ~ extract_pos_at_distance_from_point(.x, .pt = arp , .dist = 100)
            )
  ) %>%
  unnest(cols = contains("C"))

arrs <- arrs %>% select(-c(data, last_4d, rwy)) %>%
  left_join(asma %>% select(-data), by = "UID")

# ---------------------- package and write out data ---------------------------
prefix <- .fn %>% stringr::str_split(pattern = "_") %>% unlist()
prefix <- prefix[2]  # grab date
prefix <- paste0(apt, "-", prefix, "-")

print( message(paste0("... writing files for ", prefix)) )
write_csv(meta, file = paste0("./data/", prefix, "meta.csv"))
write_csv(arrs, file = paste0("./data/", prefix, "asma.csv"))

if(.debug)return(list(meta = meta, arrs = arrs))
}
```

```{r, eval=FALSE}
# apt <- "EGLL"
# apt <- "EHAM"
apt <- "LSZH"
fns <- list.files(path = paste0("./data-raw/",apt,"/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)

(   tmpp <- study_loop(.apt = apt, .fn = fns[1], .debug = TRUE)  )
```

```{r, message=FALSE}
apt <- "LSZH"
fns <- list.files(path = paste0("./data-raw/",apt, "/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)
#2nd run: fns <- fns[167:185]
# itr <- expand.grid(APT = apt, FN = fns) %>% as_tibble()
fns <- fns[51:length(fns)]

purrr::pmap(.l = list(apt = apt, fn = fns), .f = ~ study_loop(.apt = ..1, .fn = ..2))
```



Geographic indexing

```{r}
study_index <- function(.apt, .fn, .debug = FALSE, .write_bins = TRUE){
  
# ---------------------- read in airport data --------------------------------  
aip <- readr::read_csv("./data/aip.csv") %>%
  filter(ICAO == .apt) %>%
  select(RWY = REF, LAT, LON, TYPE)
# ---------------------- get landing runway & thr time -----------------------
what_date <- .fn %>% 
  stringr::str_split(pattern = "_") %>% 
  lubridate::parse_date_time("ymd")
asma_fn <- paste0("./data/", apt, "-", what_date, "-asma.csv")
ldgs <- readr::read_csv( asma_fn
                        ,col_types = cols_only( UID = col_character()
                                          ,ARR = col_logical()
                                          ,RWY = col_character()
                                          ,THR_TIME = col_datetime()
                                          )
                        )
ldgs <- ldgs %>% left_join(aip, by = "RWY")

# ---------------------- load trajectory data --------------------------------
ds <- read_feather(.fn) %>% as_tibble()
ds <- ds %>%
  make_nice_names_trafficlib() %>%
  make_unique_id() %>%
  remove_orphans(500)
ds <- ds %>%
  left_join(ldgs %>% select(UID, RWY, THR_TIME), by = "UID") %>%
  select(UID, TIME, LAT, LON, RWY, THR_TIME) %>%
  group_by(UID) %>%
  filter(TIME <= THR_TIME) %>%   # cut trajectory data to before threshold
  ungroup()
ds <- ds %>%
  bind_rows(ldgs %>% rename(TIME = THR_TIME) %>% select(-ARR)) %>%
  select(-THR_TIME) %>%           # remove unused column
  group_by(UID) %>%
  arrange(desc(TIME), .by_group = TRUE) %>% 
#------------------------  trrrj cum time and cum distance
  rename(latitude = LAT, longitude = LON, timestamp = TIME) %>% 
  cumulative_distance() %>%
  cumulative_time() %>%
  rename( TIME = timestamp, LAT = latitude, LON = longitude
         ,DIST_2GO = cumulative_distance, TIME_2GO = cumulative_time ) %>%
  mutate(TIME_2GO = - TIME_2GO) %>%     # correct sign
  ungroup()
# ---------------------- geographic indexing
ds <- ds %>%
   mutate(H3_BIN = geo_to_h3(c(LAT, LON), res = 8))

bins <- ds %>% group_by(H3_BIN, RWY) %>%
   summarise( N = n()
             ,MIN_DIST_2GO = min(DIST_2GO) , MIN_TIME_2GO = min(TIME_2GO)
             ,P20_DIST_2GO = quantile(DIST_2GO, probs = 0.2, na.rm =TRUE), P20_TIME_2GO = quantile(TIME_2GO, probs = 0.2, na.rm =TRUE)
             ,AVG_DIST_2GO = mean(DIST_2GO), AVG_TIME_2GO = mean(TIME_2GO)
             ,MAX_DIST_2GO = max(DIST_2GO) , MAX_TIME_2GO = max(TIME_2GO)
             ,.groups = "drop") %>%
  mutate(DOF = what_date)

if(.write_bins){
  warning(paste0("\nwriting bins for ", what_date, " - ", .apt))
  bin_fn <- paste0("./data/bins/", .apt, "-", what_date, "-bins.csv.gz")
  write_csv(bins, file = bin_fn)
}

if(.debug) return(list(ds, bins))
}
```

```{r, eval=FALSE}
#apt <- "EGLL"
#apt <- "EHAM"
apt <- "LSZH"
fns <- list.files(path = paste0("./data-raw/", apt), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)
(rq <- study_index(apt, fns[27]))
```

```{r, message=FALSE}
#apt <- "EGLL"
#apt <- "EHAM"
apt <- "LSZH"
fns <- list.files(path = paste0("./data-raw/",apt, "/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)
fns <- fns[173:length(fns)]

purrr::pmap(.l = list(apt = apt, fn = fns), .f = ~ study_index(.apt = ..1, .fn = ..2))
```


## Calculating Spacing results

```{r}
apt  <- "EGLL"
.apt <- apt
#fns <- list.files(path = paste0("./data-raw/",apt, "/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)
# dev files
fns <- list.files(path = paste0("./data-raw/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)
.fn <- fns[1]

# ---------------------- load trajectory data --------------------------------
warning(paste(.apt, " - reading - ", .fn))
ds <- read_feather(.fn) %>% as_tibble()

ds <- ds %>% 
  make_nice_names_trafficlib() %>%
  make_unique_id() %>% 
  remove_orphans(500)

ds <- ds %>% select(UID, TIME, LAT, LON) %>% 
  mutate(H3_BIN = geo_to_h3(c(LAT, LON), res = 8))

# ---------------------- get landing runway & thr time -----------------------
what_date <- .fn %>% 
  stringr::str_split(pattern = "_") %>% 
  lubridate::parse_date_time("ymd")
asma_fn <- paste0("./data/", apt, "-", what_date, "-asma.csv")
asma <- readr::read_csv( asma_fn
                        ,col_types = cols_only( UID = col_character()
                                         # ,ARR = col_logical()
                                          ,RWY = col_character()
                                          ,THR_TIME = col_datetime()
                                          )
)

# ---------------------- loading bins and min times --------------------------
bins_fn <- list.files(path = "./data/", pattern = "-bins.csv", full.names = TRUE)
bins <- read_csv( bins_fn
                 , col_types = cols_only(
                         H3_BIN = col_character()
                        ,   RWY = col_character()
                        ,     N = col_double()
                        ,MIN_DIST_2GO = col_double()
                        ,MIN_TIME_2GO = col_double()
                 ))

# ---------------------- glue together all data sets --------------------------
rq <- ds %>% 
  left_join(asma, by = "UID") %>%
  left_join(bins, by = c("H3_BIN", "RWY")) %>%
  mutate(TIME_2GO = THR_TIME - TIME) %>%
  filter(TIME_2GO >= 0)        # to account for t after threshold

rq <- rq %>%
  mutate(TIME_SEQ = TIME_2GO - MIN_TIME_2GO)
```


uids <- rq$UID

plot_single_time_seq <- function(.trj_binned_2go){
     df <- .trj_binned_2go
     gg <- ggplot(data = df) +
         geom_line(aes(x = TIME_2GO, y = TIME_SEQ)) +
         labs(subtitle = df$UID)
     print(gg)
 }

rq %>% filter(UID %in% sample(uids, size = 1)) %>% plot_single_time_seq()

rq %>% filter(UID == "76cd76-SIA322-2019-03-01-0") %>% ggplot() + geom_point(aes(x = LON, y = LAT, color = as.numeric(TIME_SEQ))) + scale_color_distiller(palette = "Spectral")

sia322 <- rq %>% filter(UID == "76cd76-SIA322-2019-03-01-0") 
plot_trajecory_seq_time <- function(.trj){
 df <- .trj
gg <- ggplot(data = df) + 
  geom_point(aes(x = LON, y = LAT, color = as.numeric(TIME_SEQ))) + 
  scale_color_distiller(palette = "Spectral") + 
  labs(subtitle = unique(df$UID)
       , color = "sequencing (seconds)"
       , x = NULL, y = NULL
  ) +
  theme_minimal() +
  theme(legend.position = c(0.2, 0.2)) +
#  coord_map() +
  NULL
print(gg)
return(gg)
}

check_UID <- "407464-BAW34V-2019-03-01-0"
baw34V <- rq %>% filter(UID == check_UID)

plot_to_go <- function(.trj_binned_2go){
  df <- .trj_binned_2go
  gg <- ggplot(data = df) +
         geom_line(aes(x = TIME_2GO, y = TIME_SEQ)) +
         labs(subtitle = df$UID
              , x = "time to landing runway (sec)"
              , y = "spacing effort overhead (sec)"
              ) +
         theme_minimal()
return(gg)
}

my_p <- plot_to_go(baw34V)
my_p


 baw34V %>% select(UID, TIME_2GO, TIME_SEQ) %>% mutate(TIME_SEQ2 = TIME_SEQ, TIME_SEQ = zoo::rollmedian(TIME_SEQ2, k = 15, fill = NA, align = "right")) %>% plot_to_go() + geom_abline(intercept = 0, slope = 50/1000, colour = "blue") -> finalvis
 
 ggsave(finalvis, file = "./figures/spacingmetric.png", dpi = 320, width = 8, height = 6)
 

# print some h3 bins

library(readr)
library(tidyverse)
library(h3)

ds <- read_csv("data/EGLL-2019-03-01-bins.csv")

rq <- ds %>% group_by(H3_BIN) %>% summarise(N = sum(N, na.rm=TRUE))

rq2 <- h3_to_geo_boundary_sf(rq$H3_BIN) %>% 
  mutate(H3_BIN = rq$H3_BIN, N = rq$N)
rq2

ggplot() + geom_sf(data = rq2, aes(col = log(N)) ) + scale_colour_viridis_c() + theme_minimal()

ggsave('EGLL-200NM.png', dpi=320)

ggplot() + 
  geom_sf(data = rq2, aes(fill = log(N)) ) + 
  scale_fill_viridis_c() + 
  theme_minimal() + 
  coord_sf(xlim = c(-1.5, 0.5), ylim = c(51, 52), expand = FALSE)
# might throw error - somehow min to pos does not work xlim=c(-1,0) works

ggsave('EGLL-zoom.png', dpi=320)


## ----------------------------------
# Getting some ideas about interarrival rates

used for EGLL, 2019-03-01

asma %>% group_by(RWY) %>% arrange(THR_TIME) %>% mutate(TSEP_THR = lead(THR_TIME) - THR_TIME) %>% filter(TSEP_THR <= 2500) %>% ggplot() + geom_step(mapping = aes(x = THR_TIME, y = TSEP_THR), size = 0.2) + geom_hline(yintercept = c(60, 120, 180, 240), colour = "red", linetype = "dashed") + facet_wrap(. ~ RWY, nrow = 2) + ylim(0, 300) + labs(subtitle = paste(.apt, what_date, sep = " - "), title = "Interarrival sequence, time difference in seconds over threshold", x = NULL, y = NULL) + scale_x_datetime(labels = scales::date_format("%H:%M"))+ theme_minimal()
> ggsave("./figures/EGLL-arrival-sequence-01.png")



# PRC Technical Note

Load and clean trajectory

* pick test/development day


```{r}
apt <- "EGLL"
# apt <- "EHAM"
# apt <- "LSZH"
# fns <- list.files(path = paste0("./data-raw/",apt,"/"), pattern = paste0(apt,".*\\.feather"), full.names = TRUE)

fns <- list.files(path = "./data-raw/", full.names = TRUE)

ds   <- read_feather(fns[1])

(   arrs <- study_index(.apt = apt, .fn = fns[1], .debug = TRUE, .write_bins = FALSE)  )
```

```{r}
ds <- arrs[[1]]
bins <- arrs[[2]]

inter_arrival <- ds %>% 
  filter(TYPE == "THR") %>% 
  group_by(RWY) %>%
  arrange(TIME) %>%
  mutate( SEQ_ID  = row_number()
         ,T_TRAIL = lead(TIME) - TIME )
```


WARNING - TO DO - NEED BINS based on all data!


```{r}
inter_arrival %>%
  ggplot() +
  geom_step(aes(x = TIME, y = T_TRAIL)) +
  scale_x_datetime(labels = scales::date_format("%H:%M")) +
  facet_wrap(. ~RWY) +
  labs( title = "EGLL - inter-arrival sequence"
       ,subtitle = "01-03-2019, time in UTC" 
       ,x = NULL, y = "time trailing [s]") +
  theme_minimal()

##ggsave("./figures/EGLL-arrival-sequence-00.png", dpi = 320, width = 8, height = 6)
```

boxplot for threshold - first impression

inter_arrival %>% 
  filter(T_TRAIL <= 300) %>% 
  ggplot() + 
    geom_boxplot(aes(x = RWY, y = T_TRAIL)) + 
    scale_y_continuous(limits = c(0,300)) + 
    labs(    title = "EGLL - inter-arrival sequence spread"
        , subtitle = "01-03-2019, time trailing <= 300 sec"
        , x = "arrival runway", y = "time trailing [s]"
        ) + 
    theme_minimal()

##ggsave("./figures/EGLL-arrival-sequence-box.png", dpi = 320, width = 8, height = 6)

spacing deviation (t) = min time (trailer (t)) – min time (leader (t – s))

develop function for lead-trailing time/distance calc
--> inter_arrival %>% top_n(n = -3, wt = T_TRAIL) check for some min examples

```{r}
# pick leader-follower pair
# note T_TRAIL is actually T_AHEAD := time diff from leader landing to trailer
# e.g. RWY27L SEQ_ID 76 & 77

cut_off <- 240   
couples <- inter_arrival %>%
  mutate(SEQ_UID_F = case_when(T_TRAIL <= cut_off ~ lead(UID)
                              ,TRUE ~ as.character(NA))) %>%
  #--- remove flights with only remote follower
  filter( !is.na(SEQ_UID_F) )
```

rq <- couples[1,]

add_bin_mins <- function(.trj, .bins){
  trj <- .trj %>%
    left_join(.bins %>% select(H3_BIN, RWY, MIN_DIST_2GO, MIN_TIME_2GO)
              , by = c("RWY", "H3_BIN"))
  return(trj)
}

leader <- ds %>% filter(UID == rq$UID) %>% 
  add_bin_mins(bins) %>%
  select(UID, TIME, RWY, DIST_2GO, TIME_2GO, MIN_DIST_2GO, MIN_TIME_2GO)
  
trailer<- ds %>% filter(UID == rq$SEQ_UID_F) %>% 
  add_bin_mins(bins) %>%
  select(UID, TIME, RWY, DIST_2GO, TIME_2GO, MIN_DIST_2GO, MIN_TIME_2GO) %>% 
  mutate(TIME_WARP = TIME - rq$T_TRAIL)  %>%
  rename(SEQ_UID = UID, SEQ_DIST_2GO = DIST_2GO, SEQ_TIME_2GO = TIME_2GO
        ,SEQ_MIN_DIST_2GO = MIN_DIST_2GO, SEQ_MIN_TIME_2GO = MIN_TIME_2GO)

spacedev <- leader %>% 
  left_join(trailer, by = c("TIME" = "TIME_WARP", "RWY")) %>% 
  mutate(MIN_TIME_OFF = MIN_TIME_2GO - SEQ_MIN_TIME_2GO
       , MIN_DIST_OFF = MIN_DIST_2GO - SEQ_MIN_DIST_2GO
       , DIST_OFF     = DIST_2GO - SEQ_DIST_2GO) %>% 
  select(UID, SEQ_UID, MIN_TIME_OFF, MIN_DIST_OFF, DIST_OFF, everything())


# clean with sliding window - slider

## TODO 
* wrap this in function
* reverse presentation, i.e. set index 0 = max(TIME)
* add slider smooth

spacedev %>% ggplot() + geom_line(aes(x = TIME, y = MIN_DIST_OFF))
spacedev %>% ggplot() + geom_line(aes(x = TIME, y = TIME_SPACE))

rqq <- spacedev %>% 
  mutate(TIME_SPACE = slider::slide_dbl(MIN_TIME_OFF, median, .before = 3, .after = 3))
<!-- plot it -->  
rqq %>% ggplot() + geom_line(aes(x = TIME, y = TIME_SPACE))








